# X68000 Z USB Video デバイステストアプリ zusbvideo.x

## 概要

X68000 Z に接続した USB カメラの画像を取り込むテストアプリです。


## 対応 USB カメラ

動作する USB カメラ (USB Video Class デバイス) は以下の仕様のものに限られます。

* フレームフォーマットは非圧縮または Motion JPEG をサポートしていること
* 非圧縮では 160x120 または 320x240 の解像度をサポートしていること
* High-bandwidth isochronous transfer 非対応でも動作すること\
  (ビデオストリーム受信用のエンドポイントが最大パケットサイズ 1024 バイト以下の設定をサポートしていること)

現時点では、以下のデバイスでのみ動作を確認しています。

* ELECOM UCAM-C0220FBBK (非圧縮のみ対応)
* ELECOM UCAM-C310FBBK (非圧縮/Motion JPEG)


## 使用方法

コマンドラインから以下のように実行します。

```
zusbvideo.x [-h][-v][-m][-r<resolution>][-s<video size>] [devid | vid:pid] [frames]
```

以下のオプションを指定できます。

* -h\
  ヘルプを表示します
* -v\
  取得した USB ビデオフレームパケットの情報を表示します
* -m\
  画像取得フォーマットを非圧縮から Motion JPEG に変更します
  * USB カメラが Motion JPEG に対応している必要があります
* -r\<resolution\>\
  再生時の解像度を指定します (0:表示なし 1:256×256 2:512×512)
* -s\<video size\>\
  取得する画像の解像度を指定します (0:160×120 1:320×240 2=640x480 3=800x600 4=1280x720)
  * 非圧縮の場合は 160x120 または 320x240 のみが選択できます
* devid\
  デバイス ID を指定します (省略すると UVC デバイスの一覧を表示します)
  * デバイスを VID:PID のように指定すると VID, PID が一致するデバイスを探します
* frames\
  取得するフレーム数を指定します(デフォルトは 20)。0 を指定すると、何かキーが押されるまで画像を取得し続けます


## 謝辞

Motion JPEG で使われる JPEG 画像表示のために、JPEGED.R V1.26 (砺波盛里氏、藤原尚伸氏作) (http://retropc.net/x68000/software/graphics/jpeg/jpeged/) を元に以下の変更を加えたものを取り込んでいます。感謝します。

* JPEG ファイル表示機能を残して、圧縮・保存機能を削除
* クロスコンパイル環境でビルドできるようにした
* 単体の .R 実行ファイルだったものをライブラリ化して、他のプログラムから呼び出して使えるようにした
* メモリの空きブロックすべてが画像処理用のバッファ領域として使用するようになっていたのを、あらかじめ malloc() で確保したワーク領域内のみを使うようにした
* JPEG ファイルを open, read する代わりに、メモリ上の JPEG データを表示するようにした
* 不正な入力を与えたことで画像表示処理中にアドレスエラーやバスエラー等が発生した場合も、エラーをトラップして異常終了しないようにした
* 画像展開は常に全画面表示のみとし (-F1固定)、表示解像度を 512×512 と 256×256 から選べるようにした
