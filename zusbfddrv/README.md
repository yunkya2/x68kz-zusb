# X68000 Z USB FDD ドライバ zusbfddrv.sys

## 概要

X68000 Z に接続した USB FDD を使用するためのデバイスドライバです。

HACKER'S EDITION 上で ZUSB 対応を有効にしたエミュレータが必要です。

## 使用方法

zusbfddrv.sys を X68000 Z で使用するシステムドライブにコピーして、CONFIG.SYS に以下の行を追加します。

```
DEVICE = zusbfddrv.sys [/u<ドライブ数>]
```

* `/u<ドライブ数>` には、USB FDD のドライブ数を 1～4 の値で指定します。省略した場合は 1 となります。\
指定した数のドライブ名が起動時に確保され、USB FDD が接続されると確保されたドライブ名に順次割り当てられます。

起動すると、以下のようなメッセージが表示されて USB FDD が利用できるようになります。

```
X68000 Z USB FDD device driver version xxxxxxxx
ドライブ X: でUSBフロッピーディスクが利用可能です
```

起動時に既に USB FDD が接続されていた場合は、そのデバイスのプロダクト ID 文字列が合わせて表示されます。

```
X68000 Z USB FDD device driver version xxxxxxxx
ドライブ X: でUSBフロッピーディスク (xxxxxxxx) が利用可能です
```

ディスクへのアクセス中でなければ、起動後の USB FDD の抜き差しも可能です。
USB FDD を接続せずに起動して後から接続した場合も、zusbfddrv.sys が確保したドライブ名に空きがあれば、そのドライブ名に割り当てられて利用可能になります。

## 対応ディスクフォーマット

zusbfddrv.sys は、以下のディスクフォーマットに対応しています。\
(Human68k システムディスクにある FDDEVICE.X で、X68000 実機に外部ドライブを接続した場合に使用することができたディスクフォーマットの種類と同じです)

メディア種類 | 容量 | セクタサイズ | セクタ数 | シリンダ数 | 3モードFDD |DRIVE.Xで表示される名前
----|-------:|-----:|----:|---:|------|--------------------
2HD | 1232KB | 1024 |   8 | 77 | 要   | ２ＨＤ（１ＭＢ）
2HD | 1440KB |  512 |  18 | 80 | 不要 | ２ＨＤ（１.４４ＭＢ）
2HD | 1200KB |  512 |  15 | 80 | 要   | ２ＨＣ（１ＭＢ）
2DD |  720KB |  512 |   9 | 80 | 不要 | ２ＤＤ（７２０ＫＢ）
2DD |  640KB |  512 |   8 | 80 | 不要 | ２ＤＤ（６４０ＫＢ）

**ただし、実際にこれらすべてのディスクフォーマットが扱えるとは限りません。**
どのフォーマットが扱えるかは、接続する USB FDD に依存します。

* PC 互換機で一般的に使われていたのは 2HD 1440KB 「２ＨＤ（１.４４ＭＢ）」や 2DD 720KB 「２ＤＤ（７２０ＫＢ）」だったため、どの USB FDD もこれらのフォーマットは使えるはずです。
* X68000 や PC-9801 など、国産PCで最もよく使われていたディスクフォーマットは 2HD 1232KB 「２ＨＤ（１ＭＢ）」 でした。このフォーマットを扱うには 3モード対応の USB FDD が必要です。

## 制約事項

* USB FDD のサポートは Human68k の DOS コールのレベルで行われています。ディスクアクセス IOCS コール (_B_READ など) は対応していないため、IOCS コールを使ってディスクアクセスを行うアプリは USB FDD に対しては使用できません。
* ディスクのフォーマットに FORMAT.X は使用できません (物理/論理フォーマットとも)。後述する zusbfdformat.x を使用してください。
* ディスクのベリファイには対応していません。VERIFY ON を指定しても無視されます。

## ライセンス

本デバイスドライバおよび USB FDD フォーマッタは MIT ライセンスとします。

----
----

# USB FDD フォーマッタ zusbfdformat.x

## 概要

USB FDD のディスクをフォーマットするためのツールです。
Human68k システムディスクの FORMAT.X は USB FDD には使用できないため、代わりにこのツールを使用します。

## 使用方法

コマンドラインから以下のように実行します。

```
zusbfdformat ドライブ名: [スイッチ]
```

ドライブ名 には、フォーマットを行うドライブを指定します。
コマンドラインオプションとして、以下のスイッチが指定できます。

#### FORMAT.X と同じスイッチ

* `/s` -- システムも転送する\
フォーマット後のディスクにカレントドライブからシステムファイル (HUMAN.SYS) を転送します。
フォーマット後に SYS コマンドを実行するのと同じ機能になります。
* `/v` -- ボリューム名を指定する\
フォーマット後のディスクにボリューム名を設定します。
フォーマット後に VOL コマンドを実行するのと同じ機能になります。
* `/c` -- FATとディレクトリを初期化する\
ディスクに対して物理フォーマットを行わず、論理フォーマットだけを実行します。

#### FORMAT.X と同じスイッチ (フォーマット容量指定)

FORMAT.X には未公開機能として、以下のスイッチでフォーマット容量を指定することができました。
zusbfdformat も同じスイッチをフォーマット容量指定に使用できます。
スイッチ指定がない場合には ２ＨＤ（１ＭＢ） でフォーマットします。

* `/4` -- ディスクを２ＨＤ（１.４４ＭＢ）でフォーマットする
* `/5` -- ディスクを２ＨＣ（１ＭＢ）でフォーマットする
* `/9` -- ディスクを２ＤＤ（７２０ＫＢ）でフォーマットする
* `/8` -- ディスクを２ＤＤ（６４０ＫＢ）でフォーマットする

**ただし、指定した容量で実際にフォーマットができるかどうかは、接続している USB FDD の仕様に依存します。**

使用できないフォーマットが指定された場合、通常はエラーで終了しますが、USB FDD によっては非対応のフォーマットにも関わらず、エラーを出さずにフォーマットが進行してしまうものもあるようです。
このようなドライブの場合、一見フォーマットが正常終了したように見えますが、実際には読み書きできないディスクができてしまうので注意してください。

#### 独自スイッチ

* `/l` -- フォーマット可能な容量一覧を表示する

現在挿入されているディスクに対して、そのドライブがフォーマット可能な容量の一覧を以下のように表示します。

```
X68000 Z USB FDD Formatter version xxxxxxxx
フォーマット可能容量:
２ＨＣ（１ＭＢ）        (/5)
２ＨＤ（１ＭＢ）
２ＨＤ（１.４４ＭＢ）   (/4)
```

ドライブにディスクが挿入されていなければ何も表示しません。

これは対応フォーマットを問い合わせるコマンド (READ FORMAT CAPACITIES) に対してドライブが自己申告した内容を表示しているのですが、ドライブによってはこのコマンドに正確な情報を返さないものもあるようです
(実際、この一覧に表示されたにも関わらずフォーマットできない容量のある USB FDD ドライブがありました)。
あくまで目安程度と思ってください。

----
----

# (おまけ) USB FDD ブート(のように見える)ディスクイメージ

## 概要

X68000 Z が起動する場合、エミュレータ上では 2 つの SDカードスロットを FDD に見立てて起動しますが、これを USB FDD からブートしているように見せるためのディスクイメージです。

※ 3.5インチ版の X68000 市販ソフトが X68000 Z で起動できるわけではありません

## 使用方法

1. X68000 Z の Pseudo SCSI 機能設定手順に従って、USB メモリの SCSI ディスクイメージ (HDSファイル) から起動できるように設定しておきます。
2. zusbfdboot.hds ファイルを USB メモリの X68000Z フォルダ内にコピーし、`X68000Z/pscsi.ini` ファイルを編集してこのディスクイメージから起動するように設定します。
  ```
  [pscsi]
  ID0=zusbfdboot.hds
  ```
3. X68000 Z に 2. の USB メモリと USB FDD を接続し、USB FDD に起動したいディスクを入れた状態で X68000 Z を起動します。
4. USB FDD 内のディスクから起動します (起動しているように見えます)。

## 動作原理

使用方法の手順からも分かる通り、実態は USB メモリの SCSI ディスクイメージからの起動です。
ディスクイメージ内の Human68k version 3.02 を読み込んで起動しますが、起動後に使われる SCSI デバイスドライバを USB FDD ドライバと差し替えてあり、CONFIG.SYS の読み込み以降のディスクアクセスを USB FDD に対して行うことで、FDD 起動のように見せかけています。

このため、以下のようなディスクからは起動できません。

* 起動にHuman68kを使用しないもの
* Human68k 3.02 では動作しないもの (ディスク上のHUMAN.SYSの代わりにSCSIディスクイメージのものが使われるため)
* ディスクに対して DOS コール以外の手段でアクセスするもの (市販ソフトのコピープロテクトチェックなどもこれに含まれます)

起動後のドライブ構成は以下のようになります。

- A: USB FDD ドライブ
- B: X68000 Z 本体のドライブ 0 (SDカード内のディスクイメージ)
- C: X68000 Z 本体のドライブ 1 (SDカード内のディスクイメージ)

-----
-----
